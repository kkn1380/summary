<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>íˆ¬ì ì¸ì‚¬ì´íŠ¸ | Investment Insights (ëª¨ë°”ì¼)</title>
  <style>
    body { font-family: 'Pretendard', system-ui, -apple-system, sans-serif; margin: 24px; background: #f7f7f9; }
    h1 { margin-bottom: 8px; }
    .meta { color: #666; font-size: 13px; margin-bottom: 16px; }
    .channels { color: #555; font-size: 14px; margin-bottom: 20px; padding: 12px; background: #fff; border-radius: 8px; border: 1px solid #e5e5e5; line-height: 1.6; }
    .channels-label { font-weight: 600; color: #333; margin-right: 8px; }
    .date-group { margin: 16px 0; }
    .date-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .channel-header { font-size: 16px; font-weight: 600; color: #2563eb; margin: 16px 0 8px 0; padding: 8px 12px; background: #eff6ff; border-left: 4px solid #2563eb; border-radius: 4px; }
    details { background: #fff; border: 1px solid #e5e5e5; border-radius: 8px; padding: 12px; margin-bottom: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); }
    summary { cursor: pointer; font-weight: 600; }
    .tts-btn { margin: 8px 0 4px 0; padding: 6px 10px; border-radius: 8px; border: 1px solid #ddd; background: #f5f5f7; cursor: pointer; }
    .subtitle { color: #666; font-size: 13px; margin-top: 4px; }
    pre { white-space: pre-wrap; word-break: break-word; background: #fafafa; padding: 10px; border-radius: 6px; border: 1px solid #eee; }
    .badge { display: inline-block; background: #eef2ff; color: #3730a3; border-radius: 12px; padding: 2px 8px; font-size: 12px; margin-right: 6px; }
    .search { margin: 12px 0 18px 0; }
    input[type="search"] { width: 260px; padding: 8px 10px; border-radius: 8px; border: 1px solid #ccc; }
    
    h1 { font-size: 48px; }
    summary, pre { font-size: 32px; }
    .subtitle, .meta { font-size: 20px; }
    .channels { font-size: 28px; padding: 16px; }
    .channel-header { font-size: 32px; padding: 12px 16px; }
    input[type="search"] { width: 100%; font-size: 20px; }
  
  </style>
</head>
<body>
  <h1>íˆ¬ì ì¸ì‚¬ì´íŠ¸ | Investment Insights (ëª¨ë°”ì¼)</h1>
  <div class="meta">ìƒì„±: <span id="generatedAt"></span> / ì´ <span id="total"></span>ê±´</div>
  <div class="channels">
    <span class="channels-label">ğŸ“º êµ¬ë… ì±„ë„:</span>
    <span id="channels">ë¡œë”© ì¤‘...</span>
  </div>
  <div class="search">
    <input id="search" type="search" placeholder="ì œëª©/ì±„ë„/ìš”ì•½ ê²€ìƒ‰..." />
  </div>
  <div id="root"></div>

  <script>
    const root = document.getElementById('root');
    const searchInput = document.getElementById('search');
    const generatedAtEl = document.getElementById('generatedAt');
    const totalEl = document.getElementById('total');
    const channelsEl = document.getElementById('channels');
    let payload = null;

    // JSON íŒŒì¼ ê²½ë¡œ (í™˜ê²½ì— ë”°ë¼ ìë™ ê°ì§€)
    const dataUrl = './latest.json';

    // ë°ì´í„° ë¡œë“œ
    async function loadData() {
      try {
        const response = await fetch(dataUrl);
        if (!response.ok) {
          throw new Error('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        payload = await response.json();
        generatedAtEl.textContent = new Date(payload.generatedAt).toLocaleString('ko-KR');
        totalEl.textContent = payload.items.length;
        
        // ì±„ë„ ëª©ë¡ ì¶”ì¶œ ë° í‘œì‹œ
        const channels = [...new Set(payload.items.map(item => item.channelName))].sort();
        channelsEl.textContent = channels.join(' â€¢ ');
        
        render(payload.items);
      } catch (error) {
        root.innerHTML = '<p style="color: red;">âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message + '</p>';
        console.error('Data load error:', error);
      }
    }

    function groupByDate(items) {
      const sorted = [...items].sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));
      const groups = [];
      const map = new Map();
      for (const item of sorted) {
        const d = new Date(item.publishedAt);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const key = y + '-' + m + '-' + day;
        if (!map.has(key)) {
          const group = { date: key, items: [] };
          map.set(key, group);
          groups.push(group);
        }
        map.get(key).items.push(item);
      }
      return groups;
    }

    function groupByChannel(items) {
      const channelMap = new Map();
      for (const item of items) {
        if (!channelMap.has(item.channelName)) {
          channelMap.set(item.channelName, []);
        }
        channelMap.get(item.channelName).push(item);
      }
      // ì±„ë„ëª… ì•ŒíŒŒë²³ ìˆœìœ¼ë¡œ ì •ë ¬
      return Array.from(channelMap.entries())
        .sort((a, b) => a[0].localeCompare(b[0]))
        .map(([channelName, items]) => ({ channelName, items }));
    }

    function render(list) {
      root.innerHTML = '';
      const dateGroups = groupByDate(list);
      if (dateGroups.length === 0) {
        root.textContent = 'í‘œì‹œí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.';
        return;
      }
      
      for (const dateGroup of dateGroups) {
        const dateWrapper = document.createElement('div');
        dateWrapper.className = 'date-group';
        
        const dateHeader = document.createElement('div');
        dateHeader.className = 'date-header';
        const h3 = document.createElement('h3');
        h3.textContent = dateGroup.date;
        const dateTtsBtn = document.createElement('button');
        dateTtsBtn.type = 'button';
        dateTtsBtn.className = 'tts-btn';
        dateTtsBtn.textContent = 'ğŸ”Š ë‚ ì§œ ë“£ê¸°';
        dateTtsBtn.addEventListener('click', (event) => {
          event.preventDefault();
          event.stopPropagation();
          const text = dateGroup.items
            .map(entry => `ì œëª©: ${entry.title}. ìš”ì•½: ${entry.summary}`)
            .join('\n\n');
          toggleTts(text, dateTtsBtn);
        });
        dateHeader.appendChild(h3);
        dateHeader.appendChild(dateTtsBtn);
        dateWrapper.appendChild(dateHeader);

        // ë‚ ì§œ ë‚´ì—ì„œ ì±„ë„ë³„ë¡œ ê·¸ë£¹í•‘
        const channelGroups = groupByChannel(dateGroup.items);
        
        for (const channelGroup of channelGroups) {
          // ì±„ë„ í—¤ë”
          const channelHeader = document.createElement('div');
          channelHeader.className = 'channel-header';
          channelHeader.textContent = channelGroup.channelName;
          dateWrapper.appendChild(channelHeader);
          
          // ì±„ë„ì˜ ì»¨í…ì¸ ë“¤
          channelGroup.items.forEach(item => {
            const details = document.createElement('details');
            const summary = document.createElement('summary');
            summary.textContent = item.title; // ì±„ë„ëª… ì œê±°
            
            const ttsBtn = document.createElement('button');
            ttsBtn.type = 'button';
            ttsBtn.className = 'tts-btn';
            ttsBtn.textContent = 'ğŸ”Š ë“£ê¸°';
            ttsBtn.addEventListener('click', (event) => {
              event.preventDefault();
              event.stopPropagation();
              toggleTts(item.summary, ttsBtn);
            });
            
            const meta = document.createElement('div');
            meta.className = 'meta';
            meta.innerHTML = `
              <span class="badge">ìœ íŠœë¸Œ ê²Œì‹œì¼ ${new Date(item.publishedAt).toLocaleString('ko-KR')}</span>
              <span class="badge">ì²˜ë¦¬ ${new Date(item.processedAt).toLocaleString('ko-KR')}</span>
              <span class="badge"><a href="${item.url}" target="_blank" rel="noopener">YouTube</a></span>
            `;
            
            const pre = document.createElement('pre');
            pre.textContent = item.summary;

            details.appendChild(summary);
            details.appendChild(ttsBtn);
            details.appendChild(meta);
            details.appendChild(pre);
            dateWrapper.appendChild(details);
          });
        }

        root.appendChild(dateWrapper);
      }
    }

    function matches(item, q) {
      const hay = [item.title, item.channelName, item.summary].join(' ').toLowerCase();
      return hay.includes(q);
    }

    searchInput.addEventListener('input', () => {
      if (!payload) return;
      const q = searchInput.value.trim().toLowerCase();
      if (!q) {
        render(payload.items);
        return;
      }
      render(payload.items.filter(it => matches(it, q)));
    });

    const supportsTts = 'speechSynthesis' in window;
    let currentUtterance = null;
    let currentButton = null;

    function resetTtsButton(button) {
      if (!button) return;
      button.textContent = 'ğŸ”Š ë“£ê¸°';
      button.dataset.state = 'idle';
    }

    function toggleTts(text, button) {
      if (!supportsTts) {
        alert('ì´ ë¸Œë¼ìš°ì €ëŠ” TTSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }
      if (button.dataset.state === 'playing') {
        window.speechSynthesis.cancel();
        resetTtsButton(button);
        currentUtterance = null;
        currentButton = null;
        return;
      }
      if (currentButton && currentButton !== button) {
        window.speechSynthesis.cancel();
        resetTtsButton(currentButton);
      }
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'ko-KR';
      utterance.onend = () => {
        resetTtsButton(button);
        currentUtterance = null;
        currentButton = null;
      };
      utterance.onerror = () => {
        resetTtsButton(button);
        currentUtterance = null;
        currentButton = null;
      };
      currentUtterance = utterance;
      currentButton = button;
      button.dataset.state = 'playing';
      button.textContent = 'â¹ ì¤‘ì§€';
      window.speechSynthesis.speak(utterance);
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    loadData();
  </script>
</body>
</html>